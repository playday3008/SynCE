AC_DEFUN([SYNCE_CHECK_UNSHIELD],
	[
		if test x = x$unshield_checked; then
			synce_kde_save_cflags="$CPPFLAGS"
			synce_kde_save_ldflags="$LDFLAGS"

			AC_ARG_WITH(libunshield, 
				AC_HELP_STRING(
					[--with-libunshield=DIR],
					[Search for libunshield in DIR/include and DIR/lib]
				),
				[
					UNSHIELD_INCLUDES="-I${withval}/include"
					UNSHIELD_LDFLAGS="-L${withval}/lib"
				]
			)

			AC_ARG_WITH(libunshield-include,
				AC_HELP_STRING(
					[--with-libunshield-include=DIR],
					[Search for libunshield header files in DIR]
				),
				[
					UNSHIELD_INCLUDES="-I${withval}"
				]
			)

			AC_ARG_WITH(libunshield-lib,
				AC_HELP_STRING(
					[--with-libunshield-lib=DIR],
					[Search for libunshield library files in DIR]
				),
				[
					UNSHIELD_LDFLAGS="-L${withval}"
				]
			)

			LDFLAGS="$LDFLAGS $SYNCE_LDFLAGS"
			AC_CHECK_LIB(unshield, unshield_open,
				[
					UNSHIELD_LIB="-lunshield"
				],
				[
					AC_MSG_ERROR([Can't find libunshield library])
					exit
				]
			)

			CPPFLAGS="$CPPFLAGS $UNSHIELD_INCLUDES"
			AC_CHECK_HEADERS(libunshield.h,,
				[
					AC_MSG_ERROR([Can't find libunshield.h])
					exit
				]
			)

			AC_SUBST(UNSHIELD_INCLUDES)
			AC_SUBST(UNSHIELD_LDFLAGS)
			AC_SUBST(UNSHIELD_LIB)

			CPPFLAGS="$synce_kde_save_cflags"
			LDFLAGS="$synce_kde_save_ldflags"
			unset synce_kde_save_cflags
			unset synce_kde_save_ldflags
			unshield_checked=yes
		fi
	]
)
