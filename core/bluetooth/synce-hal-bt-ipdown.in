#!/usr/bin/env python

import sys
import subprocess

sys.path.insert(0,"@SYNCEDATADIR@")
import synceconnector
from synceconnector import process_config, get_logger

def remove_device(logger, device_ip, iface, device_file):

    udi = "synce_bluetooth_device_"+device_ip.replace(".","_")

    cmd_list = ["hal-device", "--remove", udi]

    logger.debug("removing bluetooth device from hal:")
    logger.debug(cmd_list)

    try:
        proc = subprocess.Popen(cmd_list, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
        output_text = proc.communicate()[0]
    except Exception,e:
        logger.error("failure running hal-device: %s" % e)
        return False

    rc = proc.returncode

    # success returns 13
    if rc != 13:
        logger.error("failed to remove bluetooth device in hal, return code %d, %s", (rc, output_text))
        return False

    return True


if __name__ == '__main__':

    logger = get_logger("synce-hal-bt-ipdown")

    iface = sys.argv[1]
    devfile = sys.argv[2]
    speed = sys.argv[3]
    local_ip = sys.argv[4]
    device_ip = sys.argv[5]
    ipparam = sys.argv[6]

    if ipparam != "synce-bt":
        sys.exit(0)

    process_config()

    if remove_device(logger, device_ip, iface, devfile) == False:
        sys.exit(1)

    sys.exit(0)
