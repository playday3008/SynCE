#!/usr/bin/env python

import sys
import os

sys.path.insert(0,"@DATADIR@/@PACKAGE_NAME@")
import synceconnector
from synceconnector import rndis_static_config, rndis_dhcp_config, rndis_dhcp_unconfig, run_dccm, process_config

#
# main()
#
if __name__ == '__main__':

    logger = get_logger("hal-synce-rndis")

    device_path = False
    device_ip = False
    local_ip = False

    if os.environ.has_key("ACTION"):
        action = os.environ["ACTION"]

        if os.environ.has_key("INTERFACE"):
            iface = os.environ["INTERFACE"]
        else:
            logger.critical("Udev environment not set: INTERFACE missing")
            sys.exit(1)

        if os.environ.has_key("DEVPATH"):
            device_path = os.environ["DEVPATH"]
        else:
            logger.critical("Udev environment not set: DEVPATH missing")
            sys.exit(1)

    else:
        logger.warning("Environment not set, ACTION is missing")
        sys.exit(1)

    if action == "add":
        logger.debug("running as addon for interface "+iface)

        device_ip, local_ip = rndis_dhcp_config(iface)

        if device_ip == False or local_ip == False:
            logger.info("error running dhclient, trying static config")

            device_ip, local_ip = rndis_static_config(iface)
            if device_ip == False or local_ip == False:
                logger.warning("failed to configure interface")
                sys.exit(1)

        logger.debug("successfully configured interface")

        run_dccm(device_path,device_ip,local_ip,True)

        logger.error("aborting ...")
        sys.exit(1)

    if action == "remove":
        logger.debug("running for removal of interface "+iface)
        rndis_dhcp_unconfig(iface)

    sys.exit(0)

